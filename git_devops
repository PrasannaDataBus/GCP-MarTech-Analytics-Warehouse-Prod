#!/bin/bash
# =====================================================================
# GCP MarTech Analytics Warehouse - Git DevOps Guide
# This file defines the best practices and safe workflow for syncing
# code from Dev ‚Üí Prod repositories.
# =====================================================================

# ---------------------------------------------------------------------
# STEP 0 ‚Äî Overview
# ---------------------------------------------------------------------
# - Dev repo: martechanalyticsdev
# - Prod repo: martechanalyticsprod
# - Branch: master (both sides)
# - Goal: Promote tested and verified code from Dev ‚Üí Prod safely.
#
# This guide prevents commit loss, merge conflicts, and history drift.
# ---------------------------------------------------------------------

# ---------------------------------------------------------------------
# STEP 1 ‚Äî Commit & Push All Changes to Dev Repo
# ---------------------------------------------------------------------
# 1. Work on your Dev repo as usual.
# 2. Stage, commit, and push to Dev remote.
#
# Example:
#   git add .
#   git commit -m "V1.0.2 ‚Äî Enhanced Google Ads ETL logic" (you can use PyCharm UI for this)
#   git push martechanalyticsdev master (you can use PyCharm UI for this)

# HIGHLY IMPORTANT: ***** Always go through the github repo and the associated folders / files to check commit mesaage
# and you should adopt to well structured commit message practice which has been already implemented. DONT BREAK IT.
# ---------------------------------------------------------------------

# ---------------------------------------------------------------------
# STEP 2 ‚Äî Sync Dev ‚Üí Prod
# ---------------------------------------------------------------------
# From your Prod repo directory:

echo "üîÑ Fetching latest from Dev and Prod..."
git fetch martechanalyticsdev
git fetch martechanalyticsprod

# ---------------------------------------------------------------------
# STEP 2.1 ‚Äî Check Differences (for awareness)
# ---------------------------------------------------------------------
echo "Comparing Dev vs Prod..."
git diff martechanalyticsdev/master martechanalyticsprod/master --stat

# ---------------------------------------------------------------------
# STEP 2.2 ‚Äî Merge Dev changes into Prod
# ---------------------------------------------------------------------
echo "Merging Dev ‚Üí Prod..."
git merge martechanalyticsdev/master --allow-unrelated-histories || true

(OR)

git merge martechanalyticsdev/master --allow-unrelated-histories

# If README.md conflict appears, keep the Dev version automatically
if git diff --name-only --diff-filter=U | grep -q "README.md"; then
  echo "README conflict detected ‚Äî keeping Dev version"
  git checkout --ours README.md
  git add README.md
  git commit -m "Merge: resolved README conflict ‚Äî kept Dev version"
else
  echo "No merge conflicts detected."
fi

# ---------------------------------------------------------------------
# STEP 2.3 ‚Äî Push merged result to Prod
# ---------------------------------------------------------------------
echo "Pushing to Prod..."
git push martechanalyticsprod master

(OR)

git push martechanalyticsprod master --force-with-lease

# ---------------------------------------------------------------------
# STEP 3 ‚Äî Verify Sync
# ---------------------------------------------------------------------
echo "Verifying Dev ‚Üî Prod alignment..."
git fetch --all
git diff martechanalyticsdev/master martechanalyticsprod/master --stat

# ---------------------------------------------------------------------
# STEP 4 ‚Äî Tag the Release
# ---------------------------------------------------------------------
# After successful promotion, tag the Prod release.
# Example:
#   git tag -a v1.0.2 -m "Promoted stable version to Prod"
#   git push martechanalyticsprod v1.0.2
# ---------------------------------------------------------------------

# ---------------------------------------------------------------------
# BEST PRACTICES
# ---------------------------------------------------------------------
# ‚úÖ NEVER touch PROD / NEVER do changes in PROD.
# ‚úÖ Always push Dev ‚Üí Dev first before syncing to Prod.
# ‚úÖ Use descriptive semantic commit messages:
#      V1.0.0 ‚Äî Historical Backfill
#      V1.0.1 ‚Äî Incremental Loading
#      V1.1.0 ‚Äî Dev/Prod DAGs Enhancement
# ‚úÖ Pull before push if Prod is ahead (avoid rejected pushes).
# ‚úÖ Tag every stable Prod release.
# ‚úÖ Avoid 'git push --force' unless absolutely necessary.
# ‚úÖ Never rebase after pushing to shared or Prod branch.
# ‚úÖ Keep commits clean, avoid ‚ÄúCommit 1‚Äù or empty commits.
# ‚úÖ Use `git status` and `git log --oneline` often to verify state.
# ‚úÖ Resolve conflicts properly (especially README.md) before committing.
# ‚úÖ Keep .gitignore updated (exclude __pycache__, .idea, .env, etc.)
# ‚úÖ Use ‚Äú--force-with-lease‚Äù instead of plain ‚Äú--force‚Äù for safety.
# ‚úÖ Always verify the final diff before tagging a release.
# ---------------------------------------------------------------------

echo "Dev ‚Üí Prod sync completed successfully."
echo "Remember to tag the release and verify in GitHub UI."
